<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Cineroll admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Chart.js для графиков -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Nunito', sans-serif;
            background: #0a0a0a;
            color: #fffaff;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        .admin-header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #333;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .admin-header h1 {
            color: #75a744;
            font-size: 2em;
            font-weight: 900;
        }
        
        .admin-header h1 .version {
            font-size: 0.5em;
            color: #4e8387;
            vertical-align: super;
            margin-left: 5px;
        }
        
        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .last-update {
            color: #666;
            font-size: 0.9em;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #333;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .stat-card.active {
            border-color: #75a744;
        }
        
        .stat-card.postponed {
            border-color: #FFA500;
        }
        
        .stat-card.deleted {
            border-color: #dc3545;
        }
        
        .stat-card.total {
            border-color: #4e8387;
        }
        
        .stat-label {
            color: #aaa;
            font-size: 0.95em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat-label i {
            font-size: 1.2em;
        }
        
        .stat-number {
            font-size: 3em;
            font-weight: 900;
            margin: 10px 0;
        }
        
        .stat-card.active .stat-number {
            color: #75a744;
        }
        
        .stat-card.postponed .stat-number {
            color: #FFA500;
        }
        
        .stat-card.deleted .stat-number {
            color: #dc3545;
        }
        
        .stat-card.total .stat-number {
            color: #4e8387;
        }
        
        .stat-change {
            font-size: 0.9em;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .stat-change.positive {
            color: #75a744;
        }
        
        .stat-change.negative {
            color: #dc3545;
        }
        
        /* Sections */
        .admin-section {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid #333;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #4e8387;
        }
        
        .section-title {
            color: #4e8387;
            font-size: 1.5em;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            font-size: 1.2em;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            background: #333;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            color: #aaa;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #444;
            color: #fff;
        }
        
        .tab.active {
            background: #4e8387;
            color: #1a1a1a;
            font-weight: 900;
        }
        
        /* Search & Filters */
        .search-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
            padding: 14px;
            background: #333;
            border: 2px solid #444;
            border-radius: 8px;
            color: white;
            font-family: 'Nunito', sans-serif;
            font-size: 16px;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #4e8387;
        }
        
        /* Buttons */
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: #4e8387;
            color: #1a1a1a;
        }
        
        .btn-primary:hover {
            background: #3d7277;
        }
        
        .btn-success {
            background: #75a744;
            color: #1a1a1a;
        }
        
        .btn-success:hover {
            background: #66933a;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-warning {
            background: #FFA500;
            color: #1a1a1a;
        }
        
        .btn-warning:hover {
            background: #e59400;
        }
        
        .btn-secondary {
            background: #666;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #555;
        }
        
        /* Table */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #333;
            background: #1a1a1a;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        th {
            background: #2d2d2d;
            padding: 16px;
            text-align: left;
            color: #4e8387;
            font-weight: 900;
            border-bottom: 2px solid #333;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 14px 16px;
            border-bottom: 1px solid #333;
        }
        
        tr:hover {
            background: #2a2a2a;
        }
        
        .checkbox-cell {
            width: 50px;
            text-align: center;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 700;
        }
        
        .status-active {
            background: rgba(117, 167, 68, 0.2);
            color: #75a744;
            border: 1px solid #75a744;
        }
        
        .status-postponed {
            background: rgba(255, 165, 0, 0.2);
            color: #FFA500;
            border: 1px solid #FFA500;
        }
        
        .status-deleted {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 1px solid #dc3545;
        }
        
        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .chart-container {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        /* Export Cards */
        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .export-card {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #333;
            text-align: center;
        }
        
        .export-card h3 {
            color: #4e8387;
            margin-bottom: 15px;
        }
        
        .export-card p {
            color: #aaa;
            margin-bottom: 20px;
            font-size: 0.95em;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            border: 1px solid #333;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            color: #4e8387;
            font-size: 1.5em;
            font-weight: 900;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.5em;
            cursor: pointer;
        }
        
        .modal-body {
            margin-bottom: 25px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Loading */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .loading-spinner {
            border: 5px solid #333;
            border-top: 5px solid #4e8387;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #75a744;
            color: #1a1a1a;
            padding: 15px 25px;
            border-radius: 8px;
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 1001;
            animation: slideIn 0.3s ease-out;
            font-weight: 700;
        }
        
        .toast.error {
            background: #dc3545;
            color: white;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .admin-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .header-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .table-container {
                font-size: 0.9em;
            }
            
            th, td {
                padding: 10px;
            }
        }
        
        /* Checkbox styling */
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #4e8387;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Toast Notifications -->
    <div class="toast" id="toast"></div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">⚠️ Подтверждение удаления</h3>
                <button class="modal-close" onclick="closeModal('deleteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p id="deleteMessage">Вы уверены, что хотите удалить выбранные фильмы? Это действие нельзя отменить.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('deleteModal')">Отмена</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Удалить</button>
            </div>
        </div>
    </div>
    
    <!-- Bulk Actions Modal -->
    <div class="modal" id="bulkModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">⚡ Групповые действия</h3>
                <button class="modal-close" onclick="closeModal('bulkModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p id="bulkMessage">Выбрано фильмов: <span id="selectedCount">0</span></p>
                <div class="btn-group" style="flex-direction: column; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-danger" onclick="bulkDelete()">✖ Удалить выбранные</button>
                    <button class="btn btn-warning" onclick="bulkPostpone()">✱ Отложить на 24 часа</button>
                    <button class="btn btn-success" onclick="bulkActivate()">✔ Активировать выбранные</button>
                    <button class="btn btn-primary" onclick="bulkExport()">➲ Экспортировать выбранные</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <header class="admin-header">
            <h1>
                CINEROLL 
                <span class="version">v1.0</span>
            </h1>
            <div class="header-controls">
                <div class="last-update" id="lastUpdate">
                    Обновлено: только что
                </div>
                <button class="btn btn-secondary" onclick="refreshData()">
                    Обновить
                </button>
                <button class="btn btn-danger" onclick="logout()">
                    Выйти
                </button>
            </div>
        </header>
        
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-label">
                    <i></i> Всего фильмов
                </div>
                <div class="stat-number" id="totalMovies">0</div>
                <div class="stat-change" id="totalChange">
                    <span>↗</span> Данные актуальны
                </div>
            </div>
            
            <div class="stat-card active">
                <div class="stat-label">
                    <i></i> Активных
                </div>
                <div class="stat-number" id="activeMovies">0</div>
                <div class="stat-change" id="activeChange">
                    <span>↗</span> Данные актуальны
                </div>
            </div>
            
            <div class="stat-card postponed">
                <div class="stat-label">
                    <i></i> Отложенных
                </div>
                <div class="stat-number" id="postponedMovies">0</div>
                <div class="stat-change" id="postponedChange">
                    <span>↗</span> Данные актуальны
                </div>
            </div>
            
            <div class="stat-card deleted">
                <div class="stat-label">
                    <i></i> Удалено
                </div>
                <div class="stat-number" id="deletedMovies">0</div>
                <div class="stat-change" id="deletedChange">
                    <span>↗</span> Данные актуальны
                </div>
            </div>
        </div>
        
        <!-- Movie Management Section -->
        <section class="admin-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i></i> Управление фильмами
                </h2>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="openBulkActions()">
                        Групповые действия
                    </button>
                    <button class="btn btn-success" onclick="addMovieManually()">
                        Добавить фильм
                    </button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="tabs" id="movieTabs">
                <button class="tab active" data-tab="all" onclick="switchTab('all')">
                    Все фильмы
                </button>
                <button class="tab" data-tab="active" onclick="switchTab('active')">
                    Активные
                </button>
                <button class="tab" data-tab="postponed" onclick="switchTab('postponed')">
                    Отложенные
                </button>
                <button class="tab" data-tab="deleted" onclick="switchTab('deleted')">
                    Удаленные
                </button>
            </div>
            
            <!-- Search and Filters -->
            <div class="search-container">
                <input type="text" 
                       class="search-box" 
                       id="searchInput"
                       placeholder="Поиск по названию фильма..."
                       onkeyup="searchMovies()">
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="clearSearch()">
                        Очистить поиск
                    </button>
                    <button class="btn btn-primary" onclick="selectAllMovies()">
                        Выбрать все
                    </button>
                    <button class="btn btn-secondary" onclick="deselectAllMovies()">
                        Снять выделение
                    </button>
                </div>
            </div>
            
            <!-- Movies Table -->
            <div class="table-container">
                <table id="moviesTable">
                    <thead>
                        <tr>
                            <th class="checkbox-cell">
                                <input type="checkbox" id="selectAll" onclick="toggleSelectAll()">
                            </th>
                            <th>Название</th>
                            <th>Статус</th>
                            <th>Дата добавления</th>
                            <th>Время откладывания</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="moviesTableBody">
                        <tr>
                            <td colspan="6" class="empty-state">
                                Загрузка фильмов...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="btn-group" style="justify-content: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="prevPage()" id="prevBtn" disabled>
                    ◀ Назад
                </button>
                <span style="padding: 12px 20px; color: #aaa;" id="pageInfo">
                    Страница 1 из 1
                </span>
                <button class="btn btn-secondary" onclick="nextPage()" id="nextBtn" disabled>
                    Вперед ▶
                </button>
            </div>
        </section>
        
        <!-- Analytics Section -->
        <section class="admin-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i></i> Аналитика и статистика
                </h2>
                <button class="btn btn-primary" onclick="refreshCharts()">
                    Обновить графики
                </button>
            </div>
            
            <div class="charts-grid">
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
        </section>
        
        <!-- Export Section -->
        <section class="admin-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i></i> Экспорт и резервное копирование
                </h2>
                <button class="btn btn-warning" onclick="createFullBackup()">
                    Полный бэкап
                </button>
            </div>
            
            <div class="export-grid">
                <div class="export-card">
                    <h3>Экспорт в JSON</h3>
                    <p>Полная база данных в формате JSON</p>
                    <button class="btn btn-success" onclick="exportToJSON()">
                        Скачать JSON
                    </button>
                </div>
                
                <div class="export-card">
                    <h3>Экспорт в CSV</h3>
                    <p>Таблица фильмов для Excel/Google Sheets</p>
                    <button class="btn btn-success" onclick="exportToCSV()">
                        Скачать CSV
                    </button>
                </div>
                
                <div class="export-card">
                    <h3>Восстановление</h3>
                    <p>Восстановить из резервной копии</p>
                    <input type="file" id="restoreFile" accept=".json" style="display: none;">
                    <button class="btn btn-warning" onclick="document.getElementById('restoreFile').click()">
                        Загрузить бэкап
                    </button>
                </div>
                
                <div class="export-card">
                    <h3>Очистка данных</h3>
                    <p>Удалить фильмы старше 30 дней</p>
                    <button class="btn btn-danger" onclick="cleanupOldData()">
                        Очистить
                    </button>
                </div>
            </div>
        </section>
        
        <!-- System Info -->
        <section class="admin-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i>⚙️</i> Системная информация
                </h2>
                <button class="btn btn-secondary" onclick="checkDatabase()">
                    Проверить БД
                </button>
            </div>
            
            <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="stat-card">
                    <div class="stat-label">Версия БД</div>
                    <div class="stat-number" style="font-size: 2em;">v1.0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Всего записей</div>
                    <div class="stat-number" id="totalRecords">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Размер данных</div>
                    <div class="stat-number" id="dataSize">0 KB</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Статус</div>
                    <div class="stat-number" style="font-size: 1.5em; color: #75a744;" id="dbStatus">
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // ========== КОНФИГУРАЦИЯ ==========
        const firebaseConfig = {
            apiKey: "AIzaSyAOvoLXDIDZ2vVIqHLG8utXYA07yiheTkI",
            authDomain: "cineroll-54934.firebaseapp.com",
            projectId: "cineroll-54934",
            storageBucket: "cineroll-54934.firebasestorage.app",
            messagingSenderId: "158307828214",
            appId: "1:158307828214:web:6d8ed57b6d79ed80e247d7"
        };

        // ========== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ==========
        let db;
        let currentTab = 'all';
        let currentPage = 1;
        const pageSize = 20;
        let allMovies = [];
        let filteredMovies = [];
        let selectedMovieIds = new Set();
        let deleteQueue = [];
        let statusChart = null;
        let activityChart = null;
        
        // ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========
        
        // Показать уведомление
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'flex';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        // Показать/скрыть загрузку
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }
        
        // Открыть/закрыть модальное окно
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Форматирование даты
        function formatDate(date) {
            if (!date) return '—';
            const d = date.toDate ? date.toDate() : new Date(date);
            return d.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // ========== АВТОРИЗАЦИЯ ==========
        
        function checkAuth() {
            const isAuth = localStorage.getItem('cineroll_admin_auth') === 'true';
            if (!isAuth) {
                window.location.href = 'admin-login.html';
            }
        }
        
        function logout() {
            localStorage.removeItem('cineroll_admin_auth');
            localStorage.removeItem('cineroll_admin_token');
            window.location.href = 'admin-login.html';
        }
        
        // ========== ИНИЦИАЛИЗАЦИЯ FIREBASE ==========
        
        function initFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                return true;
            } catch (error) {
                console.error('Firebase ошибка:', error);
                showToast('Ошибка подключения к базе данных', 'error');
                return false;
            }
        }
        
        // ========== ЗАГРУЗКА ДАННЫХ ==========
        
        async function loadAllMovies() {
            showLoading(true);
            try {
                // Загружаем основные фильмы
                const moviesSnapshot = await db.collection('movies').get();
                const movies = [];
                
                moviesSnapshot.forEach(doc => {
                    const data = doc.data();
                    movies.push({
                        id: doc.id,
                        title: data.title || 'Без названия',
                        status: data.isActive === false ? 'postponed' : 'active',
                        addedDate: data.createdAt,
                        postponedUntil: data.postponedUntil,
                        createdAt: data.createdAt
                    });
                });
                
                // Загружаем удаленные фильмы
                const deletedSnapshot = await db.collection('deletedMovies').get();
                const deletedMovies = [];
                
                deletedSnapshot.forEach(doc => {
                    const data = doc.data();
                    deletedMovies.push({
                        id: doc.id,
                        title: data.title || 'Без названия',
                        status: 'deleted',
                        addedDate: data.createdAt || data.deletedAt,
                        deletedAt: data.deletedAt,
                        originalId: data.originalId
                    });
                });
                
                // Объединяем
                allMovies = [...movies, ...deletedMovies];
                
                // Обновляем статистику
                updateStatistics();
                
                // Обновляем таблицу
                filterMovies();
                
                // Обновляем графики
                updateCharts();
                
                // Обновляем время
                document.getElementById('lastUpdate').textContent = 
                    `Обновлено: ${new Date().toLocaleTimeString('ru-RU')}`;
                
                showToast('Данные успешно загружены');
                
            } catch (error) {
                console.error('Ошибка загрузки фильмов:', error);
                showToast('Ошибка загрузки данных', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // ========== СТАТИСТИКА ==========
        
        function updateStatistics() {
            const total = allMovies.length;
            const active = allMovies.filter(m => m.status === 'active').length;
            const postponed = allMovies.filter(m => m.status === 'postponed').length;
            const deleted = allMovies.filter(m => m.status === 'deleted').length;
            
            // Обновляем цифры
            document.getElementById('totalMovies').textContent = total;
            document.getElementById('activeMovies').textContent = active;
            document.getElementById('postponedMovies').textContent = postponed;
            document.getElementById('deletedMovies').textContent = deleted;
            
            // Обновляем системную информацию
            document.getElementById('totalRecords').textContent = total;
            document.getElementById('dataSize').textContent = Math.round(total * 0.5) + ' KB';
            document.getElementById('dbStatus').textContent = 'ok';
        }
        
        // ========== ФИЛЬТРАЦИЯ И ПОИСК ==========
        
        function switchTab(tab) {
            currentTab = tab;
            currentPage = 1;
            
            // Обновляем активную вкладку
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active');
                if (t.dataset.tab === tab) {
                    t.classList.add('active');
                }
            });
            
            filterMovies();
        }
        
        function searchMovies() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            filterMovies(searchTerm);
        }
        
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filterMovies();
        }
        
        function filterMovies(searchTerm = '') {
            // Фильтруем по вкладке
            let filtered = allMovies;
            
            if (currentTab === 'active') {
                filtered = filtered.filter(m => m.status === 'active');
            } else if (currentTab === 'postponed') {
                filtered = filtered.filter(m => m.status === 'postponed');
            } else if (currentTab === 'deleted') {
                filtered = filtered.filter(m => m.status === 'deleted');
            }
            
            // Фильтруем по поиску
            if (searchTerm) {
                filtered = filtered.filter(m => 
                    m.title.toLowerCase().includes(searchTerm)
                );
            }
            
            // Сортируем по дате (новые сначала)
            filtered.sort((a, b) => {
                const dateA = a.addedDate?.toDate ? a.addedDate.toDate() : new Date(a.addedDate);
                const dateB = b.addedDate?.toDate ? b.addedDate.toDate() : new Date(b.addedDate);
                return dateB - dateA;
            });
            
            filteredMovies = filtered;
            renderTable();
        }
        
        // ========== РЕНДЕРИНГ ТАБЛИЦЫ ==========
        
        function renderTable() {
            const tableBody = document.getElementById('moviesTableBody');
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageMovies = filteredMovies.slice(startIndex, endIndex);
            
            if (pageMovies.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            ${currentTab === 'all' ? 'Нет фильмов' : 
                              currentTab === 'active' ? 'Нет активных фильмов' :
                              currentTab === 'postponed' ? 'Нет отложенных фильмов' :
                              'Нет удаленных фильмов'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            pageMovies.forEach(movie => {
                const isSelected = selectedMovieIds.has(movie.id);
                const statusText = 
                    movie.status === 'active' ? 'Активный' :
                    movie.status === 'postponed' ? 'Отложен' : 'Удален';
                
                const statusClass = 
                    movie.status === 'active' ? 'status-active' :
                    movie.status === 'postponed' ? 'status-postponed' : 'status-deleted';
                
                const addedDate = formatDate(movie.addedDate);
                const postponedDate = movie.postponedUntil ? 
                    formatDate(movie.postponedUntil) : '—';
                
                html += `
                    <tr>
                        <td class="checkbox-cell">
                            <input type="checkbox" 
                                   ${isSelected ? 'checked' : ''}
                                   onchange="toggleMovieSelection('${movie.id}')">
                        </td>
                        <td>
                            <strong>${movie.title}</strong>
                            ${movie.originalId ? '<br><small style="color: #666;">ID: ' + movie.originalId + '</small>' : ''}
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td>${addedDate}</td>
                        <td>${postponedDate}</td>
                        <td>
                            <div class="btn-group" style="gap: 5px;">
                                ${movie.status === 'postponed' ? 
                                    `<button class="btn btn-success" style="padding: 5px 10px; font-size: 0.8em;" 
                                            onclick="activateMovie('${movie.id}')">
                                        ✔ Вернуть
                                    </button>` : ''
                                }
                                ${movie.status === 'active' ? 
                                    `<button class="btn btn-warning" style="padding: 5px 10px; font-size: 0.8em;" 
                                            onclick="postponeMovie('${movie.id}')">
                                        ⤶ Отложить
                                    </button>` : ''
                                }
                                ${movie.status !== 'deleted' ? 
                                    `<button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8em;" 
                                            onclick="deleteSingleMovie('${movie.id}')">
                                        ✖ Удалить
                                    </button>` : 
                                    `<button class="btn btn-success" style="padding: 5px 10px; font-size: 0.8em;" 
                                            onclick="restoreMovie('${movie.id}')">
                                        ↩️
                                    </button>`
                                }
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            updatePagination();
        }
        
        // ========== ПАГИНАЦИЯ ==========
        
        function updatePagination() {
            const totalPages = Math.ceil(filteredMovies.length / pageSize);
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            pageInfo.textContent = `Страница ${currentPage} из ${totalPages}`;
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
        }
        
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }
        
        function nextPage() {
            const totalPages = Math.ceil(filteredMovies.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }
        
        // ========== ВЫБОР ЭЛЕМЕНТОВ ==========
        
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageMovies = filteredMovies.slice(startIndex, endIndex);
            
            if (selectAll) {
                pageMovies.forEach(movie => selectedMovieIds.add(movie.id));
            } else {
                pageMovies.forEach(movie => selectedMovieIds.delete(movie.id));
            }
            
            renderTable();
        }
        
        function selectAllMovies() {
            filteredMovies.forEach(movie => selectedMovieIds.add(movie.id));
            document.getElementById('selectAll').checked = true;
            renderTable();
            showToast(`Выбрано ${selectedMovieIds.size} фильмов`);
        }
        
        function deselectAllMovies() {
            selectedMovieIds.clear();
            document.getElementById('selectAll').checked = false;
            renderTable();
            showToast('Выделение снято');
        }
        
        function toggleMovieSelection(movieId) {
            if (selectedMovieIds.has(movieId)) {
                selectedMovieIds.delete(movieId);
            } else {
                selectedMovieIds.add(movieId);
            }
        }
        
        // ========== ГРУППОВЫЕ ДЕЙСТВИЯ ==========
        
        function openBulkActions() {
            if (selectedMovieIds.size === 0) {
                showToast('Выберите фильмы для действий', 'error');
                return;
            }
            
            document.getElementById('selectedCount').textContent = selectedMovieIds.size;
            openModal('bulkModal');
        }
        
        async function bulkDelete() {
            closeModal('bulkModal');
            const confirmDelete = confirm(`Удалить ${selectedMovieIds.size} фильмов?`);
            
            if (!confirmDelete) return;
            
            showLoading(true);
            try {
                let successCount = 0;
                let errorCount = 0;
                
                for (const movieId of selectedMovieIds) {
                    try {
                        const movie = allMovies.find(m => m.id === movieId);
                        
                        if (movie.status === 'deleted') {
                            // Уже удаленный - удаляем из архива
                            await db.collection('deletedMovies').doc(movieId).delete();
                        } else {
                            // Активный/отложенный - перемещаем в архив
                            const movieDoc = await db.collection('movies').doc(movieId).get();
                            if (movieDoc.exists) {
                                await db.collection('deletedMovies').add({
                                    ...movieDoc.data(),
                                    deletedAt: new Date(),
                                    originalId: movieId
                                });
                                await db.collection('movies').doc(movieId).delete();
                            }
                        }
                        successCount++;
                    } catch (error) {
                        console.error(`Ошибка удаления ${movieId}:`, error);
                        errorCount++;
                    }
                }
                
                showToast(`Удалено ${successCount} фильмов${errorCount > 0 ? `, ошибок: ${errorCount}` : ''}`);
                
                // Обновляем данные
                selectedMovieIds.clear();
                await loadAllMovies();
                
            } catch (error) {
                showToast('Ошибка при массовом удалении', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function bulkPostpone() {
            closeModal('bulkModal');
            const confirmPostpone = confirm(`Отложить ${selectedMovieIds.size} фильмов на 24 часа?`);
            
            if (!confirmPostpone) return;
            
            showLoading(true);
            try {
                let successCount = 0;
                const returnTime = new Date(Date.now() + 24 * 60 * 60 * 1000);
                
                for (const movieId of selectedMovieIds) {
                    try {
                        await db.collection('movies').doc(movieId).update({
                            isActive: false,
                            postponedUntil: returnTime,
                            postponedAt: new Date()
                        });
                        successCount++;
                    } catch (error) {
                        console.error(`Ошибка откладывания ${movieId}:`, error);
                    }
                }
                
                showToast(`Отложено ${successCount} фильмов`);
                
                // Обновляем данные
                selectedMovieIds.clear();
                await loadAllMovies();
                
            } catch (error) {
                showToast('Ошибка при массовом откладывании', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function bulkActivate() {
            closeModal('bulkModal');
            const confirmActivate = confirm(`Активировать ${selectedMovieIds.size} фильмов?`);
            
            if (!confirmActivate) return;
            
            showLoading(true);
            try {
                let successCount = 0;
                
                for (const movieId of selectedMovieIds) {
                    try {
                        const movie = allMovies.find(m => m.id === movieId);
                        
                        if (movie.status === 'deleted') {
                            // Восстанавливаем из архива
                            const deletedDoc = await db.collection('deletedMovies').doc(movieId).get();
                            if (deletedDoc.exists) {
                                const data = deletedDoc.data();
                                await db.collection('movies').doc(data.originalId || movieId).set({
                                    title: data.title,
                                    isActive: true,
                                    createdAt: data.createdAt || new Date(),
                                    postponedUntil: null
                                });
                                await db.collection('deletedMovies').doc(movieId).delete();
                            }
                        } else {
                            // Активируем активный/отложенный
                            await db.collection('movies').doc(movieId).update({
                                isActive: true,
                                postponedUntil: null
                            });
                        }
                        successCount++;
                    } catch (error) {
                        console.error(`Ошибка активации ${movieId}:`, error);
                    }
                }
                
                showToast(`Активировано ${successCount} фильмов`);
                
                // Обновляем данные
                selectedMovieIds.clear();
                await loadAllMovies();
                
            } catch (error) {
                showToast('Ошибка при массовой активации', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        function bulkExport() {
            closeModal('bulkModal');
            const selectedMovies = allMovies.filter(m => selectedMovieIds.has(m.id));
            
            if (selectedMovies.length === 0) return;
            
            const exportData = selectedMovies.map(movie => ({
                title: movie.title,
                status: movie.status,
                addedDate: formatDate(movie.addedDate),
                postponedUntil: movie.postponedUntil ? formatDate(movie.postponedUntil) : '',
                id: movie.id
            }));
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cineroll-selected-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`Экспортировано ${selectedMovies.length} фильмов`);
        }
        
        // ========== ОТДЕЛЬНЫЕ ДЕЙСТВИЯ ==========
        
        async function deleteSingleMovie(movieId) {
            const movie = allMovies.find(m => m.id === movieId);
            const confirmDelete = confirm(`Удалить фильм "${movie.title}"?`);
            
            if (!confirmDelete) return;
            
            showLoading(true);
            try {
                if (movie.status === 'deleted') {
                    // Окончательное удаление из архива
                    await db.collection('deletedMovies').doc(movieId).delete();
                    showToast('Фильм окончательно удален');
                } else {
                    // Перемещение в архив
                    const movieDoc = await db.collection('movies').doc(movieId).get();
                    if (movieDoc.exists) {
                        await db.collection('deletedMovies').add({
                            ...movieDoc.data(),
                            deletedAt: new Date(),
                            originalId: movieId
                        });
                        await db.collection('movies').doc(movieId).delete();
                        showToast('Фильм перемещен в архив');
                    }
                }
                
                await loadAllMovies();
                
            } catch (error) {
                showToast('Ошибка удаления фильма', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function activateMovie(movieId) {
            showLoading(true);
            try {
                await db.collection('movies').doc(movieId).update({
                    isActive: true,
                    postponedUntil: null
                });
                
                showToast('Фильм активирован');
                await loadAllMovies();
                
            } catch (error) {
                showToast('Ошибка активации фильма', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function postponeMovie(movieId) {
            showLoading(true);
            try {
                const returnTime = new Date(Date.now() + 24 * 60 * 60 * 1000);
                
                await db.collection('movies').doc(movieId).update({
                    isActive: false,
                    postponedUntil: returnTime,
                    postponedAt: new Date()
                });
                
                showToast('Фильм отложен на 24 часа');
                await loadAllMovies();
                
            } catch (error) {
                showToast('Ошибка откладывания фильма', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function restoreMovie(movieId) {
            showLoading(true);
            try {
                const deletedDoc = await db.collection('deletedMovies').doc(movieId).get();
                if (deletedDoc.exists) {
                    const data = deletedDoc.data();
                    await db.collection('movies').doc(data.originalId || movieId).set({
                        title: data.title,
                        isActive: true,
                        createdAt: data.createdAt || new Date(),
                        postponedUntil: null
                    });
                    await db.collection('deletedMovies').doc(movieId).delete();
                    
                    showToast('Фильм восстановлен');
                    await loadAllMovies();
                }
            } catch (error) {
                showToast('Ошибка восстановления фильма', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // ========== ЭКСПОРТ ==========
        
        async function exportToJSON() {
            showLoading(true);
            try {
                const moviesSnapshot = await db.collection('movies').get();
                const deletedSnapshot = await db.collection('deletedMovies').get();
                
                const movies = [];
                moviesSnapshot.forEach(doc => {
                    movies.push({
                        id: doc.id,
                        ...doc.data(),
                        createdAt: doc.data().createdAt?.toDate().toISOString(),
                        postponedUntil: doc.data().postponedUntil?.toDate().toISOString()
                    });
                });
                
                const deleted = [];
                deletedSnapshot.forEach(doc => {
                    deleted.push({
                        id: doc.id,
                        ...doc.data(),
                        createdAt: doc.data().createdAt?.toDate().toISOString(),
                        deletedAt: doc.data().deletedAt?.toDate().toISOString()
                    });
                });
                
                const exportData = {
                    exportDate: new Date().toISOString(),
                    version: '1.0',
                    movies: movies,
                    deletedMovies: deleted
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cineroll-full-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showToast('Полный бэкап экспортирован');
                
            } catch (error) {
                showToast('Ошибка экспорта', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function exportToCSV() {
            showLoading(true);
            try {
                const snapshot = await db.collection('movies').get();
                let csv = 'Название;Статус;Дата добавления;Отложен до\n';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const status = data.isActive === false ? 'Отложен' : 'Активный';
                    const added = data.createdAt?.toDate().toLocaleDateString('ru-RU') || '';
                    const postponed = data.postponedUntil?.toDate().toLocaleDateString('ru-RU') || '';
                    
                    // Экранируем точку с запятой
                    const title = `"${(data.title || '').replace(/"/g, '""')}"`;
                    
                    csv += `${title};${status};${added};${postponed}\n`;
                });
                
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cineroll-films-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                
                showToast('CSV экспортирован');
                
            } catch (error) {
                showToast('Ошибка экспорта CSV', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function createFullBackup() {
            showLoading(true);
            try {
                // Создаем бэкап всех коллекций
                const backupData = {
                    timestamp: new Date().toISOString(),
                    collections: {}
                };
                
                // Получаем список всех коллекций
                const collections = ['movies', 'deletedMovies', 'postponedMovies'];
                
                for (const collectionName of collections) {
                    const snapshot = await db.collection(collectionName).get();
                    backupData.collections[collectionName] = [];
                    
                    snapshot.forEach(doc => {
                        backupData.collections[collectionName].push({
                            id: doc.id,
                            data: doc.data()
                        });
                    });
                }
                
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cineroll-system-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showToast('Системный бэкап создан');
                
            } catch (error) {
                showToast('Ошибка создания бэкапа', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // ========== ГРАФИКИ ==========
        
        function updateCharts() {
            updateStatusChart();
            updateActivityChart();
        }
        
        function updateStatusChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            // Уничтожаем старый график
            if (statusChart) {
                statusChart.destroy();
            }
            
            const active = allMovies.filter(m => m.status === 'active').length;
            const postponed = allMovies.filter(m => m.status === 'postponed').length;
            const deleted = allMovies.filter(m => m.status === 'deleted').length;
            
            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Активные', 'Отложенные', 'Удаленные'],
                    datasets: [{
                        data: [active, postponed, deleted],
                        backgroundColor: [
                            'rgba(117, 167, 68, 0.8)',
                            'rgba(255, 165, 0, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ],
                        borderColor: [
                            'rgba(117, 167, 68, 1)',
                            'rgba(255, 165, 0, 1)',
                            'rgba(220, 53, 69, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#fff',
                                font: {
                                    family: 'Nunito',
                                    size: 14
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Распределение фильмов по статусам',
                            color: '#4e8387',
                            font: {
                                family: 'Nunito',
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
        }
        
        function updateActivityChart() {
            const ctx = document.getElementById('activityChart').getContext('2d');
            
            // Уничтожаем старый график
            if (activityChart) {
                activityChart.destroy();
            }
            
            // Группируем по дням
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last7Days.push(date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }));
            }
            
            // Считаем добавления по дням
            const addedData = [0, 0, 0, 0, 0, 0, 0];
            
            allMovies.forEach(movie => {
                if (movie.addedDate) {
                    const addedDate = movie.addedDate.toDate ? movie.addedDate.toDate() : new Date(movie.addedDate);
                    const daysAgo = Math.floor((new Date() - addedDate) / (1000 * 60 * 60 * 24));
                    
                    if (daysAgo >= 0 && daysAgo <= 6) {
                        addedData[6 - daysAgo]++;
                    }
                }
            });
            
            activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'Добавлено фильмов',
                        data: addedData,
                        backgroundColor: 'rgba(78, 131, 135, 0.2)',
                        borderColor: 'rgba(78, 131, 135, 1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff',
                                font: {
                                    family: 'Nunito',
                                    size: 14
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Активность добавления фильмов (7 дней)',
                            color: '#4e8387',
                            font: {
                                family: 'Nunito',
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#aaa'
                            },
                            grid: {
                                color: '#333'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#aaa'
                            },
                            grid: {
                                color: '#333'
                            }
                        }
                    }
                }
            });
        }
        
        function refreshCharts() {
            updateCharts();
            showToast('Графики обновлены');
        }
        
        // ========== СИСТЕМНЫЕ ФУНКЦИИ ==========
        
        async function cleanupOldData() {
            const confirmCleanup = confirm('Удалить фильмы, добавленные более 30 дней назад?');
            
            if (!confirmCleanup) return;
            
            showLoading(true);
            try {
                const monthAgo = new Date();
                monthAgo.setDate(monthAgo.getDate() - 30);
                
                const snapshot = await db.collection('movies')
                    .where('createdAt', '<', monthAgo)
                    .get();
                
                if (snapshot.empty) {
                    showToast('Нет старых фильмов для удаления');
                    return;
                }
                
                let count = 0;
                snapshot.forEach(async doc => {
                    await db.collection('deletedMovies').add({
                        ...doc.data(),
                        deletedAt: new Date(),
                        originalId: doc.id,
                        cleanupReason: 'old_data'
                    });
                    
                    await db.collection('movies').doc(doc.id).delete();
                    count++;
                });
                
                showToast(`Удалено ${count} старых фильмов`);
                await loadAllMovies();
                
            } catch (error) {
                showToast('Ошибка очистки данных', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        function checkDatabase() {
            const collections = ['movies', 'deletedMovies', 'postponedMovies'];
            let totalDocs = 0;
            
            showLoading(true);
            
            // Проверяем каждую коллекцию
            Promise.all(collections.map(collection => 
                db.collection(collection).get().then(snap => snap.size)
            )).then(sizes => {
                totalDocs = sizes.reduce((a, b) => a + b, 0);
                
                document.getElementById('totalRecords').textContent = totalDocs;
                document.getElementById('dataSize').textContent = Math.round(totalDocs * 0.5) + ' KB';
                document.getElementById('dbStatus').textContent = '✅ Исправна';
                document.getElementById('dbStatus').style.color = '#75a744';
                
                showToast(`База данных проверена: ${totalDocs} записей`);
                
            }).catch(error => {
                document.getElementById('dbStatus').textContent = '❌ Ошибка';
                document.getElementById('dbStatus').style.color = '#dc3545';
                showToast('Ошибка проверки базы данных', 'error');
            }).finally(() => {
                showLoading(false);
            });
        }
        
        function refreshData() {
            selectedMovieIds.clear();
            loadAllMovies();
        }
        
        function addMovieManually() {
            const title = prompt('Введите название фильма:');
            if (!title) return;
            
            showLoading(true);
            
            db.collection('movies').add({
                title: title,
                isActive: true,
                createdAt: new Date(),
                postponedUntil: null
            }).then(() => {
                showToast('Фильм добавлен');
                loadAllMovies();
            }).catch(error => {
                showToast('Ошибка добавления фильма', 'error');
            }).finally(() => {
                showLoading(false);
            });
        }
        
        // ========== ВОССТАНОВЛЕНИЕ ИЗ БЭКАПА ==========
        
        document.getElementById('restoreFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const confirmRestore = confirm('ВНИМАНИЕ! Восстановление перезапишет текущие данные. Продолжить?');
            if (!confirmRestore) {
                e.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(event) {
                showLoading(true);
                try {
                    const backupData = JSON.parse(event.target.result);
                    
                    // Восстанавливаем фильмы
                    if (backupData.collections?.movies) {
                        for (const movie of backupData.collections.movies) {
                            await db.collection('movies').doc(movie.id).set(movie.data);
                        }
                    }
                    
                    // Восстанавливаем удаленные
                    if (backupData.collections?.deletedMovies) {
                        for (const movie of backupData.collections.deletedMovies) {
                            await db.collection('deletedMovies').doc(movie.id).set(movie.data);
                        }
                    }
                    
                    showToast('Данные восстановлены из бэкапа');
                    await loadAllMovies();
                    
                } catch (error) {
                    showToast('Ошибка восстановления данных', 'error');
                } finally {
                    showLoading(false);
                    e.target.value = '';
                }
            };
            
            reader.readAsText(file);
        });
        
        // ========== ИНИЦИАЛИЗАЦИЯ ==========
        
        document.addEventListener('DOMContentLoaded', function() {
            // Проверяем авторизацию
            checkAuth();
            
            // Инициализируем Firebase
            if (!initFirebase()) {
                showToast('Ошибка инициализации Firebase', 'error');
                return;
            }
            
            // Загружаем данные
            loadAllMovies();
            
            // Автообновление каждые 30 секунд
            setInterval(() => {
                if (!document.hidden) {
                    loadAllMovies();
                }
            }, 30000);
            
            // Обработчик видимости страницы
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    loadAllMovies();
                }
            });
        });
    </script>
</body>
</html>
